<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RateQuote GitHub Actions Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            margin-bottom: 30px;
        }

        h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .token-input {
            flex: 1;
            min-width: 300px;
            padding: 10px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            background: #238636;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }

        button:hover {
            background: #2ea043;
        }

        button:disabled {
            background: #21262d;
            cursor: not-allowed;
        }

        select, input[type="text"] {
            padding: 10px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat {
            background: #161b22;
            padding: 15px 20px;
            border-radius: 6px;
            border: 1px solid #30363d;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
        }

        .status-in_progress { color: #f0883e; }
        .status-queued { color: #8b949e; }
        .status-completed { color: #3fb950; }
        .status-success { color: #3fb950; }
        .status-failure { color: #f85149; }
        .status-cancelled { color: #8b949e; }

        table {
            width: 100%;
            background: #161b22;
            border-radius: 6px;
            border: 1px solid #30363d;
            border-collapse: collapse;
            overflow: hidden;
        }

        th {
            background: #21262d;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #8b949e;
            border-bottom: 1px solid #30363d;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #30363d;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover {
            background: #21262d;
        }

        .repo-name {
            font-weight: 600;
            color: #58a6ff;
        }

        .workflow-name {
            color: #c9d1d9;
        }

        .branch {
            color: #8b949e;
            font-size: 12px;
        }

        .time {
            color: #8b949e;
            font-size: 12px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: lowercase;
        }

        .status-badge.in_progress {
            background: rgba(240, 136, 62, 0.15);
            color: #f0883e;
        }

        .status-badge.queued {
            background: rgba(139, 148, 158, 0.15);
            color: #8b949e;
        }

        .status-badge.success {
            background: rgba(63, 185, 80, 0.15);
            color: #3fb950;
        }

        .status-badge.failure {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
        }

        .status-badge.cancelled {
            background: rgba(139, 148, 158, 0.15);
            color: #8b949e;
        }

        a {
            color: #58a6ff;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #8b949e;
        }

        .error {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .empty {
            text-align: center;
            padding: 60px;
            color: #8b949e;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auto-refresh label {
            font-size: 14px;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸš€ RateQuote GitHub Actions Dashboard</h1>
            <p style="color: #8b949e; margin-top: 10px;">Real-time view of all GitHub Actions runs across the organization</p>
        </header>

        <div class="controls">
            <input
                type="password"
                id="token"
                class="token-input"
                placeholder="GitHub Personal Access Token (required)"
                autocomplete="off"
            />
            <select id="statusFilter">
                <option value="all">All Statuses</option>
                <option value="in_progress" selected>In Progress</option>
                <option value="queued">Queued</option>
                <option value="completed">Completed</option>
            </select>
            <input type="text" id="repoFilter" placeholder="Filter by repo name..." />
            <button id="refreshBtn">Refresh</button>
            <div class="auto-refresh">
                <input type="checkbox" id="autoRefresh" />
                <label for="autoRefresh">Auto-refresh (30s)</label>
            </div>
        </div>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat">
                <div class="stat-value status-in_progress" id="stat-in_progress">0</div>
                <div class="stat-label">In Progress</div>
            </div>
            <div class="stat">
                <div class="stat-value status-queued" id="stat-queued">0</div>
                <div class="stat-label">Queued</div>
            </div>
            <div class="stat">
                <div class="stat-value status-success" id="stat-success">0</div>
                <div class="stat-label">Success (24h)</div>
            </div>
            <div class="stat">
                <div class="stat-value status-failure" id="stat-failure">0</div>
                <div class="stat-label">Failure (24h)</div>
            </div>
        </div>

        <div id="error" class="error" style="display: none;"></div>
        <div id="loading" class="loading" style="display: none;">Loading workflow runs...</div>
        <div id="empty" class="empty" style="display: none;">No workflow runs found</div>

        <table id="runsTable" style="display: none;">
            <thead>
                <tr>
                    <th>Repository</th>
                    <th>Workflow</th>
                    <th>Branch</th>
                    <th>Status</th>
                    <th>Started</th>
                    <th>Commit</th>
                    <th>Link</th>
                </tr>
            </thead>
            <tbody id="runsBody"></tbody>
        </table>
    </div>

    <script>
        const ORG = 'RateQuote';
        let autoRefreshInterval = null;

        // Load token from localStorage
        const savedToken = localStorage.getItem('gh_token');
        if (savedToken) {
            document.getElementById('token').value = savedToken;
        }

        // Save token on change
        document.getElementById('token').addEventListener('change', (e) => {
            if (e.target.value) {
                localStorage.setItem('gh_token', e.target.value);
            } else {
                localStorage.removeItem('gh_token');
            }
        });

        async function fetchAllRepos(token) {
            const repos = [];
            let page = 1;
            let hasMore = true;

            while (hasMore) {
                const response = await fetch(`https://api.github.com/orgs/${ORG}/repos?per_page=100&page=${page}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to fetch repos: ${response.statusText}`);
                }

                const data = await response.json();
                repos.push(...data);
                hasMore = data.length === 100;
                page++;
            }

            return repos;
        }

        async function fetchWorkflowRuns(token, repo, status = 'all') {
            const params = new URLSearchParams({
                per_page: '10',
            });

            if (status !== 'all') {
                params.append('status', status);
            }

            const response = await fetch(
                `https://api.github.com/repos/${ORG}/${repo}/actions/runs?${params}`,
                {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                }
            );

            if (!response.ok) {
                if (response.status === 404) {
                    // Repo doesn't have Actions enabled
                    return [];
                }
                throw new Error(`Failed to fetch runs for ${repo}: ${response.statusText}`);
            }

            const data = await response.json();
            return data.workflow_runs.map(run => ({
                ...run,
                repository_name: repo
            }));
        }

        async function loadAllRuns() {
            const token = document.getElementById('token').value.trim();
            const statusFilter = document.getElementById('statusFilter').value;
            const repoFilter = document.getElementById('repoFilter').value.toLowerCase();

            if (!token) {
                showError('Please enter a GitHub Personal Access Token');
                return;
            }

            hideError();
            showLoading();
            hideTable();
            hideEmpty();

            try {
                // Fetch all repos
                const repos = await fetchAllRepos(token);
                const filteredRepos = repoFilter
                    ? repos.filter(r => r.name.toLowerCase().includes(repoFilter))
                    : repos;

                // Fetch workflow runs for all repos in parallel
                const runPromises = filteredRepos.map(repo =>
                    fetchWorkflowRuns(token, repo.name, statusFilter).catch(err => {
                        console.error(`Error fetching runs for ${repo.name}:`, err);
                        return [];
                    })
                );

                const runArrays = await Promise.all(runPromises);
                const allRuns = runArrays.flat();

                // Sort by created_at descending
                allRuns.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                hideLoading();

                if (allRuns.length === 0) {
                    showEmpty();
                    updateStats({});
                } else {
                    displayRuns(allRuns);
                    updateStats(allRuns);
                    showTable();
                }
            } catch (error) {
                hideLoading();
                showError(error.message);
                console.error('Error:', error);
            }
        }

        function displayRuns(runs) {
            const tbody = document.getElementById('runsBody');
            tbody.innerHTML = '';

            runs.forEach(run => {
                const row = document.createElement('tr');

                const statusClass = run.conclusion || run.status;
                const displayStatus = run.conclusion || run.status;

                const timeAgo = getTimeAgo(new Date(run.created_at));

                row.innerHTML = `
                    <td><span class="repo-name">${run.repository_name}</span></td>
                    <td><span class="workflow-name">${run.name}</span></td>
                    <td><span class="branch">${run.head_branch}</span></td>
                    <td><span class="status-badge ${statusClass}">${displayStatus}</span></td>
                    <td><span class="time">${timeAgo}</span></td>
                    <td><span class="time">${run.head_sha.substring(0, 7)}</span></td>
                    <td><a href="${run.html_url}" target="_blank">View â†’</a></td>
                `;

                tbody.appendChild(row);
            });
        }

        function updateStats(runs) {
            const stats = {
                in_progress: 0,
                queued: 0,
                success: 0,
                failure: 0
            };

            if (Array.isArray(runs)) {
                const oneDayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);

                runs.forEach(run => {
                    if (run.status === 'in_progress') stats.in_progress++;
                    if (run.status === 'queued') stats.queued++;

                    const runDate = new Date(run.created_at);
                    if (runDate > oneDayAgo) {
                        if (run.conclusion === 'success') stats.success++;
                        if (run.conclusion === 'failure') stats.failure++;
                    }
                });
            }

            document.getElementById('stat-in_progress').textContent = stats.in_progress;
            document.getElementById('stat-queued').textContent = stats.queued;
            document.getElementById('stat-success').textContent = stats.success;
            document.getElementById('stat-failure').textContent = stats.failure;
            document.getElementById('stats').style.display = 'flex';
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return `${seconds}s ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
            return `${Math.floor(seconds / 86400)}d ago`;
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showTable() {
            document.getElementById('runsTable').style.display = 'table';
        }

        function hideTable() {
            document.getElementById('runsTable').style.display = 'none';
        }

        function showEmpty() {
            document.getElementById('empty').style.display = 'block';
        }

        function hideEmpty() {
            document.getElementById('empty').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function setupAutoRefresh() {
            const checkbox = document.getElementById('autoRefresh');

            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    autoRefreshInterval = setInterval(loadAllRuns, 30000);
                } else {
                    if (autoRefreshInterval) {
                        clearInterval(autoRefreshInterval);
                        autoRefreshInterval = null;
                    }
                }
            });
        }

        // Event listeners
        document.getElementById('refreshBtn').addEventListener('click', loadAllRuns);
        document.getElementById('statusFilter').addEventListener('change', loadAllRuns);
        document.getElementById('repoFilter').addEventListener('input',
            debounce(() => loadAllRuns(), 500)
        );

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Initialize
        setupAutoRefresh();

        // Auto-load if token is present
        if (savedToken) {
            loadAllRuns();
        }
    </script>
</body>
</html>
